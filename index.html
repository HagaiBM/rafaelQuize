<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>משימת רפאל: חידון הממציאים</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Heebo', sans-serif; background: linear-gradient(to right, #004e92, #000428); color: #e0e0e0; overflow: hidden; }
    .font-orbitron { font-family: 'Orbitron', sans-serif; }
    .tech-glow { text-shadow: 0 0 5px rgba(0,255,255,0.7), 0 0 10px rgba(0,255,255,0.5); }
    .main-container { backdrop-filter: blur(10px); background: rgba(10,25,47,0.6); border: 1px solid rgba(0,255,255,0.3); box-shadow: 0 0 30px rgba(0,255,255,0.2); }
    .btn-primary { background: rgba(0,191,255,0.8); border: 1px solid #00ffff; box-shadow: 0 0 10px rgba(0,255,255,0.5); transition: all .3s; }
    .btn-primary:hover { background: #00ffff; color: #000428; transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,255,0.8); }
    .answer-option { background: rgba(23,58,94,0.7); border: 1px solid rgba(0,255,255,0.4); transition: .2s; }
    .answer-option:not(.disabled):hover { background: rgba(0,255,255,0.2); border-color: #00ffff; transform: translateX(-10px); }
    .correct { background: rgba(15,255,131,0.8); border-color: #0fff83; color: #000; animation: pulse-correct .5s; }
    .incorrect { background: rgba(255,59,48,0.8); border-color: #ff3b30; color: #fff; animation: shake-horizontal .5s; }
    .disabled { pointer-events: none; opacity: .7; }
    @keyframes shake-horizontal { 0%,100%{transform:translateX(0)} 10%,30%,50%,70%{transform:translateX(-10px)} 20%,40%,60%,80%{transform:translateX(10px)} }
    @keyframes pulse-correct { 0%{transform:scale(1)} 70%{transform:scale(1.05); box-shadow:0 0 10px 15px rgba(15,255,131,0)} 100%{transform:scale(1)} }
    .fade-in { animation: fadeIn .5s ease forwards; }
    .fade-out { animation: fadeOut .5s ease forwards; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
    @keyframes fadeOut { from{opacity:1; transform:translateY(0)} to{opacity:0; transform:translateY(-20px)} }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

  <!-- סאונד - אפשר להשאיר או להחליף לנתיבים משלך. יש fallback בקוד JS -->
  <audio id="sound-correct" crossorigin="anonymous" preload="auto"
         src="https://assets.mixkit.co/sfx/preview/mixkit-success-bell-win-2876.mp3"></audio>
  <audio id="sound-wrong" crossorigin="anonymous" preload="auto"
         src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-2875.mp3"></audio>

  <div id="game-container" class="main-container w-full max-w-3xl mx-auto rounded-2xl p-6 md:p-10 text-center">
    <!-- מסך פתיחה -->
    <div id="start-screen" class="fade-in">
      <h1 class="font-orbitron text-4xl md:text-6xl font-black tech-glow mb-4">משימת רפאל</h1>
      <h2 class="text-2xl md:text-3xl mb-8">חידון הממציאים</h2>
      <p class="text-lg mb-10 max-w-xl mx-auto">
        הוכיחו שיש לכם את מה שצריך כדי להצטרף לצוות הפיתוח של רפאל! ענו על השאלות, צברו נקודות והפכו לגיבורי הטכנולוגיה הבאים.
      </p>
      <div class="flex gap-3 justify-center mb-4">
        <button id="start-btn" class="btn-primary font-orbitron text-2xl font-bold py-3 px-12 rounded-lg">התחל משימה</button>
        <button id="test-sound-btn" class="btn-primary font-orbitron text-lg font-bold py-3 px-6 rounded-lg">בדיקת סאונד</button>
      </div>
      <p class="opacity-75 text-sm">אם אין סאונד, לחץ קודם על בדיקת סאונד כדי לאפשר השמעה.</p>
    </div>

    <!-- מסך חידון -->
    <div id="quiz-screen" class="hidden">
      <div id="hud" class="flex justify-between items-center mb-6 font-orbitron text-lg">
        <div id="progress-text" class="tech-glow"></div>
        <div id="timer-text" class="tech-glow">10</div>
        <div id="score-text" class="tech-glow">ניקוד: 0</div>
      </div>
      <div id="question-container" class="mb-8">
        <h2 id="question" class="text-2xl md:text-3xl font-bold mb-8 min-h-[100px]">טוען שאלה...</h2>
        <div id="answer-options" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
    </div>

    <!-- מסך סיום -->
    <div id="end-screen" class="hidden">
      <h1 class="font-orbitron text-4xl md:text-5xl font-black tech-glow mb-4">משימה הושלמה!</h1>
      <p class="text-xl mb-6">כל הכבוד, סיימתם את חידון הממציאים!</p>
      <div class="bg-gray-900/50 rounded-lg p-6 mb-8">
        <h2 class="text-2xl font-bold mb-2">הניקוד הסופי שלך:</h2>
        <p id="final-score" class="font-orbitron text-6xl font-bold tech-glow">0</p>
      </div>
      <p id="end-message" class="text-lg mb-10"></p>
      <button id="restart-btn" class="btn-primary font-orbitron text-2xl font-bold py-3 px-12 rounded-lg">שחק שוב</button>
    </div>
  </div>

  <script>
    // ---------- Web Audio fallback ואנלוק ----------
    let audioCtx = null;
    function ensureAudioUnlocked() {
      try {
        if (!audioCtx) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          audioCtx = new Ctx();
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
        // ביפ קצר כדי לפתוח הרשאה
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g).connect(audioCtx.destination);
        o.frequency.value = 880;
        g.gain.value = 0.0001;
        o.start();
        g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.12);
        o.stop(audioCtx.currentTime + 0.13);
      } catch (e) {
        console.warn('Audio unlock error:', e);
      }
    }

    function beep(freq = 440, duration = 0.2) {
      try {
        ensureAudioUnlocked();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.value = freq;
        o.connect(g).connect(audioCtx.destination);
        g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
        o.start();
        o.stop(audioCtx.currentTime + duration + 0.02);
      } catch (e) {
        console.warn('WebAudio beep failed:', e);
      }
    }

    async function safePlay(el, fallbackFreq) {
      try {
        // ודא טעינה בסיסית
        if (el.readyState < 2) { el.load(); }
        el.currentTime = 0;
        el.volume = 1;
        const p = el.play();
        if (p && typeof p.then === 'function') await p;
      } catch (err) {
        console.warn('Audio file failed, using fallback beep. Reason:', err);
        beep(fallbackFreq, 0.18);
      }
    }

    // ---------- נתוני השאלות ----------
    const questions = [
      { question: "באיזו שנה קמה המעבדה הסודית שהפכה לרפאל?", answers: [
        { text: "1967", correct: false },
        { text: "1948", correct: true },
        { text: "1973", correct: false },
        { text: "1956", correct: false }
      ]},
      { question: "מיהו המדען המבריק, שהיה מפקד בחיל המדע ולימים הפך לנשיא הרביעי של ישראל?", answers: [
        { text: "חיים ויצמן", correct: false },
        { text: "דוד בן-גוריון", correct: false },
        { text: "פרופ' אפרים קציר", correct: true },
        { text: "יצחק רבין", correct: false }
      ]},
      { question: "איזו מערכת הגנה היא כמו \"מגן בלתי נראה\" לטנקים, שמיירטת טילים לפני שהם פוגעים?", answers: [
        { text: "כיפת ברזל", correct: false },
        { text: "קלע דוד", correct: false },
        { text: "מעיל רוח", correct: true },
        { text: "מגן אור", correct: false }
      ]},
      { question: "איזו מערכת משתמשת בקרן לייזר כדי ליירט איומים קטנים ומהירים?", answers: [
        { text: "מגן אור", correct: true },
        { text: "ברק 8", correct: false },
        { text: "Litening Pod", correct: false },
        { text: "BNET", correct: false }
      ]},
      { question: "איזו מערכת נקראת על שם גיבור תנ\"כי שהשתמש ברוגטקה כדי להביס ענק?", answers: [
        { text: "קלע דוד", correct: true },
        { text: "מעוז", correct: false },
        { text: "ברדים", correct: false },
        { text: "ICE BREAKER", correct: false }
      ]},
      { question: "איזה מוצר מאפשר תקשורת מאובטחת בשדה הקרב?", answers: [
        { text: "BNET", correct: true },
        { text: "SPICE (ברד)", correct: false },
        { text: "Drone Dome", correct: false },
        { text: "ענני סערה", correct: false }
      ]},
      { question: "איזו מערכת מכונה \"שרביט קסמים\"?", answers: [
        { text: "קלע דוד", correct: true },
        { text: "מגן אור", correct: false },
        { text: "BNET", correct: false },
        { text: "מעיל רוח", correct: false }
      ]},
      { question: "איזו מערכת היא טיל אוויר-אוויר מדור חמישי של רפאל?", answers: [
        { text: "Python-5", correct: true },
        { text: "I-Derby ER", correct: false },
        { text: "Spike-ER", correct: false },
        { text: "BRDS", correct: false }
      ]},
      { question: "איזה פצ\"ה כולל GPS וחיישן אופטי לגילוי מדויק?", answers: [
        { text: "SPICE (ברד)", correct: true },
        { text: "מעיל רוח", correct: false },
        { text: "מעוז", correct: false },
        { text: "Litening Pod", correct: false }
      ]},
      { question: "מהי המערכת המגוונת להגנה מפני רחפנים עוינים?", answers: [
        { text: "Drone Dome", correct: true },
        { text: "BNET", correct: false },
        { text: "מעיל רוח", correct: false },
        { text: "ברדים", correct: false }
      ]},
      { question: "איזה פוד נותן ראייה תרמית ואופטית?", answers: [
        { text: "Litening Pod", correct: true },
        { text: "מגן אור", correct: false },
        { text: "מעיל רוח", correct: false },
        { text: "BNET", correct: false }
      ]}
    ];

    const SCORE_POINTS = 100;

    // ---------- מצביעים לאלמנטים ----------
    const startBtn = document.getElementById('start-btn');
    const testSoundBtn = document.getElementById('test-sound-btn');
    const restartBtn = document.getElementById('restart-btn');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const endScreen = document.getElementById('end-screen');
    const questionEl = document.getElementById('question');
    const answerEl = document.getElementById('answer-options');
    const progressText = document.getElementById('progress-text');
    const timerText = document.getElementById('timer-text');
    const scoreText = document.getElementById('score-text');
    const finalScore = document.getElementById('final-score');
    const endMessage = document.getElementById('end-message');
    const soundCorrect = document.getElementById('sound-correct');
    const soundWrong = document.getElementById('sound-wrong');

    // ---------- מצב משחק ----------
    let currentQuestionIndex = 0;
    let score = 0;
    let accepting = false;
    let timerInterval = null;
    let timerTimeout = null;
    let timeLeft = 10;

    // ---------- ניהול מסכים ואנימציות ----------
    function showScreen(target) {
      [startScreen, quizScreen, endScreen].forEach(s => {
        s.classList.add('hidden');
        s.classList.remove('fade-in', 'fade-out');
      });
      target.classList.remove('hidden');
      target.classList.add('fade-in');
    }

    // ---------- התחלת משחק ----------
    function startGame() {
      ensureAudioUnlocked(); // פותח הרשאת אודיו
      clearTimers();
      currentQuestionIndex = 0;
      score = 0;
      accepting = false;
      updateHud();
      showScreen(quizScreen);
      showQuestion();
    }

    // ---------- הצגת שאלה ----------
    function showQuestion() {
      clearTimers();
      timeLeft = 10;
      updateTimer();

      // טיימר שניות וחיתוך זמן
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0) handleTimeout();
      }, 1000);
      timerTimeout = setTimeout(handleTimeout, 10000);

      const q = questions[currentQuestionIndex];
      questionEl.textContent = q.question;

      // יצירת תשובות
      answerEl.innerHTML = '';
      const shuffled = [...q.answers].sort(() => Math.random() - 0.5);
      shuffled.forEach(a => {
        const btn = document.createElement('button');
        btn.textContent = a.text;
        btn.className = 'answer-option w-full p-4 rounded-lg text-lg font-bold text-right';
        btn.dataset.correct = a.correct;
        btn.addEventListener('click', handleAnswer);
        answerEl.appendChild(btn);
      });

      accepting = true;
      updateHud();
    }

    // ---------- טיפול בבחירה ----------
    async function handleAnswer(e) {
      if (!accepting) return;
      accepting = false;
      clearTimers();

      const selected = e.target;
      const correct = selected.dataset.correct === 'true';

      if (correct) {
        score += SCORE_POINTS;
        selected.classList.add('correct');
        await safePlay(soundCorrect, 880);
      } else {
        selected.classList.add('incorrect');
        await safePlay(soundWrong, 220);
        const correctBtn = answerEl.querySelector('[data-correct="true"]');
        if (correctBtn) correctBtn.classList.add('correct');
      }

      Array.from(answerEl.children).forEach(b => b.classList.add('disabled'));
      updateHud();

      setTimeout(nextQuestion, 2000);
    }

    // ---------- זמן נגמר ----------
    function handleTimeout() {
      if (!accepting) return;
      accepting = false;
      clearTimers();
      Array.from(answerEl.children).forEach(b => b.classList.add('disabled'));
      nextQuestion();
    }

    // ---------- ניקוי טיימרים ----------
    function clearTimers() {
      if (timerInterval) clearInterval(timerInterval);
      if (timerTimeout) clearTimeout(timerTimeout);
      timerInterval = null;
      timerTimeout = null;
    }

    // ---------- מעבר לשאלה הבאה/סיום ----------
    function nextQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        showQuestion();
      } else {
        endGame();
      }
    }

    // ---------- עדכון כותרת עליונה ----------
    function updateHud() {
      progressText.textContent = `שאלה ${Math.min(currentQuestionIndex + 1, questions.length)} / ${questions.length}`;
      scoreText.textContent = `ניקוד: ${score}`;
    }

    function updateTimer() {
      timerText.textContent = timeLeft;
    }

    // ---------- מסך סיום ----------
    function endGame() {
      clearTimers();
      finalScore.textContent = score;
      const pct = (score / (questions.length * SCORE_POINTS)) * 100;
      if (pct === 100)      endMessage.textContent = "תוצאה מושלמה! את/ה גאון/ה טכנולוגי/ת! רפאל מחכה לך!";
      else if (pct >= 80)   endMessage.textContent = "מרשים ביותר! יש לך חשיבה של מהנדס/ת בכיר/ה.";
      else if (pct >= 50)   endMessage.textContent = "עבודה טובה! המשך/י לחקור ולהתעניין, ואת/ה בדרך הנכונה.";
      else                  endMessage.textContent = "התחלה טובה! כל מסע מתחיל בצעד אחד. נסה/י שוב כדי לשפר את הידע שלך!";
      showScreen(endScreen);
    }

    // ---------- התחלה מחדש ----------
    function restart() {
      ensureAudioUnlocked();
      clearTimers();
      currentQuestionIndex = 0;
      score = 0;
      accepting = false;
      updateHud();
      showScreen(quizScreen);
      showQuestion();
    }

    // ---------- חיבורים ----------
    document.getElementById('start-btn').addEventListener('click', startGame);
    document.getElementById('restart-btn').addEventListener('click', restart);

    // כפתור בדיקת סאונד
    document.getElementById('test-sound-btn').addEventListener('click', async () => {
      ensureAudioUnlocked();
      await safePlay(soundCorrect, 880);
      setTimeout(() => safePlay(soundWrong, 220), 350);
    });
  </script>
</body>
</html>
